<!DOCTYPE html>
<html>
    <head>
        <title>Datefort</title>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
        <link rel="stylesheet" href="style.css">
        <link rel="stylesheet" href="css/animate.css">

        <!-- Fonts -->
        <link href='http://fonts.googleapis.com/css?family=Oswald:700' rel='stylesheet' type='text/css'>


        <!-- Get Scripts -->
    	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
        <!-- <script src="app/event.js"></script>-->
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>


        <!-- BEGIN ARCGIS -->
		<link rel="stylesheet" href="http://js.arcgis.com/3.13/esri/css/esri.css">
		<script src="http://js.arcgis.com/3.13/"></script>
		<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true"></script>
		<script>
			function getActivityJson(activityCallback) {
				var amenities = [
					"Archery",
					"Baseball",
					"Basketball",
					"Birding",
					"BMX Jump Park",
					"Bocce",
					"Cricket",
					"Disc Golf",
					"Off-leash Dog area",
					"Equestrian Arena",
					"Fishing",
					"Golf Clubhouse",
					"Outdoor Gym",
					"Pickleball",
					"Skateboard",
					"Soccer",
					"Softball",
					"Tennis",
					"Volleyball",
					"Ice Skating",
					"Swimming Pool",
					"Trailhead",
					"Zoo"
				];
				var activity = amenities[Math.floor(Math.random() * amenities.length)];
				var qsActivity = activity.replace(' ', '+');
				var notParkAmenities = [
					"Archery",
					"Golf Clubhouse",
					"Ice Skating",
					"Nature Center",
					"Off-leash Dog area",
					"Swimming Pool",
					"Trailhead",
					"Zoo"
				]
						
				var isPark = true;
				var tableNumber = 3;
				var query = "Amenity%3D%27" + qsActivity + "%27";
				var outFields = "ParkName,ParkID";
				var placeName = "";
				var address = "";
						
				for (i=0; i < notParkAmenities.length && isPark; i++) {
					if (activity == notParkAmenities[i]) {
						isPark = false;
					}
				}
				if (!isPark) {
					//set vars
					tableNumber = 0;
					query = "FacilType%3D%27" + activity + "%27+and+Address+is+not+null";
					outFields = "FacilityName%2CAddress";
				}

				$.get("http://gismaps.cityofboise.org/arcgis/rest/services/OpenData/BoiseParksOpenData/MapServer/"
						+ tableNumber + "/query?where=" + query + "&outFields=" + outFields + "&f=pjson",
				function( data ) {
					var jsonObj = $.parseJSON(data)
					var choices = jsonObj['features'];
					place = choices[Math.floor(Math.random() * choices.length)]
					
					if (isPark) {
						placeName = place.attributes.ParkName;
						var parkID = place.attributes.ParkID;
						var addressJson = "http://gismaps.cityofboise.org/arcgis/rest/services/OpenData/BoiseParksOpenData/MapServer/1/query?where=ParkID%3D%27" + parkID + "%27&outFields=Address&f=pjson";
						$.get(addressJson, function(data2){
							addressFeature = $.parseJSON(data2)
							if (addressFeature.features.length != 1) {
								return getActivityJson(activityCallback);
							}
							else {
								address = addressFeature.features[0].attributes.Address;
								var activityObj = {
								"activity" : activity,
								"placeName" : placeName,
								"address" : address
								}
								activityCallback(activityObj);
							}
						})
					}
					else {
						placeName = place.attributes.FacilityName;
						address= place.attributes.Address;
						var activityObj = {
								"activity" : activity,
								"placeName" : placeName,
								"address" : address
								}
								activityCallback(activityObj);
					}
					
				});
							
			}
			function activityJsonCallback(activityObject) {
				$('.activity').html(activityObject.activity);
				$('.placeName').html(activityObject.placeName);
				$('.address').html(activityObject.address);
			}

			function refreshData(){
				getActivityJson(getRestaurantData);
//				getRestaurantData();
			}
			function getRestaurantData(activityObject){
				activityJsonCallback(activityObject);
				
				$.ajax({
					dataType: "jsonp",
					url: "http://maps.googleapis.com/maps/api/geocode/json?address=" + activityObject.address
				}).done(function(data){
					var lat = data.lat//"43.590363"
					var lon = data.long//"-116.2331255"
					
					$.ajax({
						dataType: "jsonp",
						url: "http://api.yelp.com/business_review_search?term=restaurant&lat="
								+ lat + "&long=" + lon + "&offset=0&radius=1&limit=20&sort=0&ywsid=_Dyh7bReZ1QVwPnf_Vs0ZQ"
					}).done(function (data){
						console.log(data);
						var choices = data.businesses;
						place = choices[Math.floor(Math.random() * choices.length)]
						$('.restaurant').html(place.name);
						$('.star-rating').attr("src", place.rating_img_url);
						console.log(place);
						
						
					});
				});
			}

			
			$(document).ready(function() {
				refreshData();
			});
			
			function initialize() {
				var myLatlng = new google.maps.LatLng(-25.363882,131.044922);
				var mapOptions = {
					zoom: 4,
					center: myLatlng
				}
				var map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

				var marker = new google.maps.Marker({
					position: myLatlng,
					map: map,
					title: 'Hello World!'
				});
			}

			google.maps.event.addDomListener(window, 'load', initialize);
		</script>
		
		</head>

		<body>

			<div class="container">
				<div class="row">
					<img src="img/logo.svg" class="center-block logo animated bounceInDown">
				</div>
				<div class="row spacer">

					<div class="col-md-6 animated bounceIn">
						<img src="img/activity.svg" class="activity inputLogo center-block">
						<div class="infoHolder center-block">
							<p><span class="activity"></span> at <span class="placeName"></span></p>
							<div id="map-canvas"></div>
						</div>
					</div>
					<div class="col-md-6 animated bounceIn">
						<img src="img/dinner.svg" class="dinner inputLogo center-block">
						<div class="infoHolder center-block">
							<p>
								<span>Eat at </span>
								<span class="restaurant"></span> 
								<img class="star-rating" src="">
							</p>
							<div id="map-canvasDinner"></div>
						</div>
					</div>

				</div>
				<div class="row spacer">
					<button class="btn btn-default date center-block" type="submit" onClick="refreshData()">RAN-DATE-OMIZE</button>
				</div>
				<div class="row spacer">
					<p class="note">*Bring your own supplies and date.</p>
				</div>

				<div id="map-canvas"></div>
			</div>

			
			
		</body>
</html>


